<!doctype html>
<meta charset="utf-8">
<title>Price & Strong Buy models</title>
<style>
  body{font-family:-apple-system,Segoe UI,Helvetica,Arial,sans-serif;margin:20px;}
  .wrap{max-width:1100px;margin:0 auto}
  .card{margin:22px 0;padding:12px 16px;border:1px solid #e5e5e5;border-radius:12px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:6px 0 12px}
  label{display:flex;align-items:center;gap:6px;font-size:13px}
  canvas{width:100%;height:320px}
  small{color:#666}
</style>
<div class="wrap">
  <h2>Price & Strong Buy score (last 12 hours)</h2>
  <div class="row"><small>Left axis: price. Right axis: score (0–100). Hourly labels; 15‑min ticks.</small></div>
  <div id="charts"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<script>
async function load() {
  const res = await fetch('data.json?v=' + Date.now(), {cache:'no-store'});
  const data = await res.json();
  const root = document.getElementById('charts');

  const colors = {
    price: '#1f77b4',
    M1: '#2ca02c',  // green
    M2: '#d62728',  // red
    M3: '#9467bd',  // purple
    M4: '#ff7f0e',  // orange
    M5: '#17becf'   // cyan
  };

  for (const [sym, rec] of Object.entries(data.symbols)) {
    const card = document.createElement('div'); card.className='card';
    const title = document.createElement('div');
    title.innerHTML = `<b>${sym}</b>`;
    const controls = document.createElement('div'); controls.className='row';
    const c = document.createElement('canvas');

    // model toggles
    const toggles = ['M1','M2','M3','M4','M5'];
    const active = {M1:false, M2:true, M3:false, M4:false, M5:false}; // default show M2 only

    toggles.forEach(k => {
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=!!active[k];
      cb.id = sym+'_'+k;
      const lab = document.createElement('label'); lab.htmlFor = cb.id;
      lab.style.color = colors[k]; lab.appendChild(cb); lab.append(` ${k}`);
      controls.appendChild(lab);
      cb.addEventListener('change', () => update());
    });

    card.appendChild(title);
    card.appendChild(controls);
    card.appendChild(c);
    root.appendChild(card);

    const ctx = c.getContext('2d');
    const labels = data.labels.map(s => new Date(s));
    const chart = new Chart(ctx, {
      type: 'line',
      data: {labels, datasets: []},
      options: {
        responsive:true,
        interaction:{mode:'nearest',intersect:false},
        plugins:{
          legend:{display:false}
        },
        scales:{
          x:{type:'time', time:{tooltipFormat:'HH:mm', displayFormats:{minute:'HH:mm'}},
             ticks:{autoSkip:true, maxTicksLimit:25}},
          y:{position:'left', title:{display:false}},
          y1:{position:'right', min:0, max:100, grid:{drawOnChartArea:false}}
        }
      }
    });

    function update(){
      const ds = [];
      ds.push({label:sym+' price', data: rec.close, borderColor:colors.price, backgroundColor:colors.price,
               yAxisID:'y', tension:0.25, pointRadius:0});
      for (const k of toggles) {
        if (document.getElementById(sym+'_'+k).checked) {
          ds.push({label:k, data: (rec.scores && rec.scores[k]) ? rec.scores[k] : rec.score,
                   borderColor:colors[k], backgroundColor:colors[k], yAxisID:'y1',
                   tension:0.25, pointRadius:0, borderDash: k==='M2' ? [6,4] : undefined});
        }
      }
      chart.data.datasets = ds;
      chart.update('none');
    }
    update();
  }
}
load();
</script>
