<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Price & M-signals (48h) — fixed size + reliable toggles</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root {
    --bg: #f6f7f9;
    --card: #fff;
    --ink: #111;
    --muted: #666;
    --line: #e5e7eb;
  }
  html, body { margin: 0; padding: 0; background: var(--bg); color: var(--ink); font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  .container { max-width: 1200px; margin: 20px auto 80px; padding: 0 16px; }
  h1 { font-size: 22px; margin: 6px 0 14px; }
  .note { color: var(--muted); font-size: 13px; margin-bottom: 8px; }
  .card { background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 12px; margin: 18px auto; }
  .head { display:flex; align-items:center; gap:12px; flex-wrap: wrap; margin: 6px 0 8px; }
  .sym { font-weight: 700; letter-spacing: 0.1px; }
  .controls { display:flex; gap:10px; row-gap: 8px; flex-wrap: wrap; font-size: 13px; }
  .controls label { display:inline-flex; align-items:center; gap:6px; padding:6px 8px; border:1px solid var(--line); border-radius: 8px; user-select:none; }
  .controls input[type="checkbox"] { transform: translateY(1px); }
  .controls input[type="number"] { width: 64px; padding:6px 8px; border:1px solid var(--line); border-radius:8px; }
  .fixed-canvas { width: 100% !important; height: 360px !important; display: block; }
  .legend { color: var(--muted); font-size: 12px; margin-top: 6px; }
</style>
</head>
<body>
<div class="container">
  <h1>Price & M-signals (48h) — fixed size + reliable toggles</h1>
  <div class="note">Left axis: price. Right axis: score (0–100). Hourly labels; 15-minute ticks.</div>
  <div id="charts"></div>
</div>

<!-- Chart.js + time adapter -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<script src="./vendor/time-adapter-guard.js"></script>
<script>
const PALETTE = [
  "#2563eb","#dc2626","#16a34a","#9333ea","#0891b2",
  "#ea580c","#4f46e5","#059669","#db2777","#6d28d9",
  "#d97706","#0e7490"
];
const MODELS = ["M1","M2","M3","M4","M5","M6","M7","M8","M9","M10"];

function el(type, attrs={}, children=[]) {
  const n = document.createElement(type);
  for (const [k,v] of Object.entries(attrs)) {
    if (k === "class") n.className = v;
    else if (k === "text") n.textContent = v;
    else n.setAttribute(k,v);
  }
  for (const c of children) n.appendChild(c);
  return n;
}

function makeCard(sym, onToggle) {
  const card = el("div", {class:"card"});
  const head = el("div", {class:"head"});
  head.appendChild(el("div", {class:"sym", text:sym}));

  const controls = el("div", {class:"controls"});
  // price checkbox (on by default)
  controls.appendChild(controlCheckbox(sym, "price", true, onToggle));

  // M1..M10 (off by default)
  for (const m of MODELS) controls.appendChild(controlCheckbox(sym, m, false, onToggle));

  head.appendChild(controls);
  card.appendChild(head);

  // canvas
  const canvas = el("canvas", {class:"fixed-canvas"});
  card.appendChild(canvas);

  // tiny legend line
  const legend = el("div", {class:"legend", text:"Toggle lines above. Score axis is fixed at 0–100."});
  card.appendChild(legend);

  return {card, canvas};
}

function controlCheckbox(sym, key, checked, onToggle) {
  const id = `${sym.replace(/[^A-Za-z0-9]/g,"_")}_${key}`;
  const input = el("input", {type:"checkbox", id});
  input.checked = checked;
  input.addEventListener("change", () => onToggle(sym, key, input.checked));
  const label = el("label");
  const spanTxt = (key === "price") ? "price" : key;
  label.appendChild(input);
  label.appendChild(el("span", {text: spanTxt}));
  return label;
}

function buildChart(ctx, labels, series, sym) {
  const price = series.close || [];
  const datasets = [];
  // price
  datasets.push({
    label: sym + " price",
    xAxisID: "x",
    yAxisID: "yPrice",
    data: price,
    borderColor: PALETTE[0],
    backgroundColor: PALETTE[0],
    borderWidth: 2,
    pointRadius: 0,
    tension: 0.25,
    spanGaps: true,
    hidden: false
  });

  // models M1..M10 (start hidden)
  MODELS.forEach((m, i) => {
    const arr = series[m] || [];
    datasets.push({
      label: m,
      xAxisID: "x",
      yAxisID: "yScore",
      data: arr,
      borderColor: PALETTE[(i+1)%PALETTE.length],
      backgroundColor: PALETTE[(i+1)%PALETTE.length],
      borderWidth: 1.5,
      pointRadius: 0,
      tension: 0.25,
      spanGaps: true,
      hidden: true
    });
  });

  const chart = new Chart(ctx, {
    type: "line",
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false, // we control height via CSS
      animation: false,
      parsing: false,
      interaction: { mode: "nearest", intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: { enabled: true }
      },
      scales: {
        x: {
          type: "time",
          time: { tooltipFormat: "MMM d, HH:mm", displayFormats: { minute: "HH:mm" } },
          ticks: { autoSkip: true, maxTicksLimit: 24 }
        },
        yPrice: {
          type: "linear",
          position: "left",
          grid: { drawOnChartArea: true }
        },
        yScore: {
          type: "linear",
          position: "right",
          min: 0, max: 100,
          grid: { drawOnChartArea: false }
        }
      }
    }
  });
  return chart;
}

(async function main(){
  try {
    const res = await fetch("data.json?t=" + Date.now(), {cache:"no-store"});
    const d = await res.json();
    const labels = d.labels || [];
    const symbols = d.symbols || {};
    const wrap = document.getElementById("charts");

    const charts = new Map(); // sym => {chart, datasetsIndexMap}
    function onToggle(sym, key, checked) {
      const rec = charts.get(sym);
      if (!rec) return;
      const { chart, map } = rec;
      if (key === "price") {
        chart.data.datasets[ map.price ].hidden = !checked;
      } else {
        const idx = map.models[key];
        if (idx != null) chart.data.datasets[idx].hidden = !checked;
      }
      chart.update("none");
    }

    Object.keys(symbols).forEach((sym, sIdx) => {
      const series = symbols[sym] || {};
      const {card, canvas} = makeCard(sym, onToggle);
      wrap.appendChild(card);

      const ctx = canvas.getContext("2d");
      const chart = buildChart(ctx, labels, series, sym);

      // cache dataset indexes
      const map = {
        price: 0,
        models: {}
      };
      MODELS.forEach((m, i) => map.models[m] = 1 + i); // after price
      charts.set(sym, {chart, map});
    });
  } catch (e) {
    console.error("viewer init failed", e);
    alert("Failed to load data.json. Check console.");
  }
})();
</script>
</body>
</html>
