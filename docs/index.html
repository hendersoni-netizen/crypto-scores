<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Price & M-signals (48h) — working viewer (M1..M10)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<style>
  :root{--fg:#111;--muted:#64748b;--border:#e5e7eb;--bg:#fff;--card:#fafafa}
  html,body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 12px}
  h1{margin:0 0 8px;font-size:20px}
  .hint{color:var(--muted);font-size:12px;margin-bottom:18px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 12px 8px;margin:16px 0}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:4px 0 10px}
  .spacer{flex:1}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px 8px;background:#fff}
  .badge input{transform:translateY(1px)}
  .kv{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:8px;padding:4px 8px;background:#fff}
  .lbl{color:#0f172a;font-weight:600}
  canvas{width:100%;height:360px;display:block}
  .legend{display:flex;align-items:center;gap:14px;margin:6px 0 2px;color:var(--muted);font-size:12px}
  .dot{width:10px;height:10px;border-radius:50%}
</style>
</head>
<body>
<div class="wrap">
  <h1>Price &amp; M-signals (48h) — fixed size + axis mapping (working)</h1>
  <div class="hint">Left axis: price. Right axis: score (0–100). Hourly labels; 15‑minute ticks. Dashed = hidden by default. This page reads <code>docs/data.json</code>.</div>
  <div id="charts"></div>
</div>

<!-- Chart.js + date adapter -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<script src="vendor/time-adapter-guard.js"></script>

<script>
(async function(){
  const root = document.getElementById('charts');

  // helper: make section
  function makeSection(sym){
    const card = document.createElement('div');
    card.className = 'card';

    const row = document.createElement('div');
    row.className = 'row';
    const title = document.createElement('div');
    title.className = 'lbl';
    title.textContent = sym;
    row.appendChild(title);

    // controls
    const ctrl = (id,label,checked=false)=>{
      const span = document.createElement('label');
      span.className='badge';
      span.innerHTML = '<input type="checkbox" '+(checked?'checked':'')+' data-id="'+id+'"> <span>'+label+'</span>';
      return span;
    };
    const ids = ['price','M1','M2','M3','M4','M5','M6','M7','M8','M9','M10'];
    row.appendChild(ctrl('price','price',true));
    ids.slice(1).forEach(s=> row.appendChild(ctrl(s,s,false)));

    row.appendChild(Object.assign(document.createElement('div'),{className:'spacer'}));
    card.appendChild(row);

    const leg = document.createElement('div');
    leg.className='legend';
    leg.innerHTML = '<span class="dot" style="background:#2563eb"></span> '+sym+' price';
    card.appendChild(leg);

    const c = document.createElement('canvas');
    card.appendChild(c);

    root.appendChild(card);
    return {canvas:c, card};
  }

  function palette(i){
    const colors = ['#2563eb','#ef4444','#22c55e','#a855f7','#f59e0b','#06b6d4','#fb7185','#10b981','#8b5cf6','#f97316','#3b82f6'];
    return colors[i % colors.length];
  }

  // fetch data.json
  async function loadJSON(){
    const res = await fetch('data.json?t=' + Date.now(), {cache:'no-store'});
    if(!res.ok) throw new Error('Failed to fetch data.json: ' + res.status);
    return res.json();
  }

  const data = await loadJSON();
  const labels = (data.labels||[]).map(ts=> new Date(ts));
  const symbols = data.symbols || {};

  for(const sym of Object.keys(symbols)){
    const {canvas} = makeSection(sym);
    const series = symbols[sym] || {};
    const price = series.close || series.price || [];

    // datasets for M1..M10 if present
    function makeM(id){
      return (series[id] || series[id.toLowerCase()] || series[id.replace('M','model')] || []).slice();
    }

    const ds = [];
    // Price (left axis)
    ds.push({
      label: sym + ' price',
      yAxisID: 'y',
      data: price,
      borderColor: palette(0),
      backgroundColor: palette(0),
      tension: 0.25,
      pointRadius: 0,
    });

    // M1..M10 (right axis, hidden by default)
    for(let i=1;i<=10;i++){
      const key = 'M'+i;
      const arr = makeM(key);
      if(arr.length){
        ds.push({
          label: key,
          yAxisID: 'yR',
          data: arr,
          borderColor: palette(i),
          backgroundColor: palette(i),
          tension: 0.2,
          spanGaps: true,
          pointRadius: 0,
          hidden: true, // start hidden; checkbox toggles
        });
      }
    }

    const ctx = canvas.getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: ds },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'nearest', intersect: false },
        scales: {
          x: {
            type: 'time',
            time: { tooltipFormat: 'HH:mm', displayFormats: { minute:'HH:mm', hour:'HH:mm' } },
            ticks: { source:'auto' }
          },
          y: {
            position: 'left',
            ticks: { callback: v => v },
            grid: { drawOnChartArea: true }
          },
          yR: {
            position: 'right',
            min: 0, max: 100,
            grid: { drawOnChartArea: false },
            ticks: { stepSize: 20 }
          }
        },
        plugins: { legend: { display:false } }
      }
    });

    // wire up checkboxes in this card
    const inputs = canvas.parentElement.querySelectorAll('input[type="checkbox"]');
    inputs.forEach(inp=>{
      inp.addEventListener('change', ()=>{
        const id = inp.getAttribute('data-id');
        if(id==='price'){
          chart.data.datasets[0].hidden = !inp.checked;
        } else {
          const idx = chart.data.datasets.findIndex(d=>d.label===id);
          if(idx>-1){ chart.data.datasets[idx].hidden = !inp.checked; }
        }
        chart.update('none');
      });
    });
  }
})();
</script>
</body>
</html>
