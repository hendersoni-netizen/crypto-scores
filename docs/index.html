<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Price & M-signals (48h) — fixed size + reliable toggles</title>
  <style>
    :root{--card-w:1120px;--canvas-h:360px;--muted:#6b7280}
    body{font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin:24px; color:#111}
    h1{font-size:20px;margin:0 0 12px 0}
    .meta{color:var(--muted);font-size:12px;margin-bottom:14px}
    .card{max-width:var(--card-w); border:1px solid #e5e7eb; border-radius:12px; padding:12px 12px 18px 12px; margin:16px 0; box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:6px 6px 10px 6px}
    .row label{font-size:13px; color:#111; display:inline-flex; align-items:center; gap:6px; padding:3px 8px; border:1px solid #e5e7eb; border-radius:999px}
    .row input[type="number"]{width:64px; padding:3px 6px; border:1px solid #e5e7eb; border-radius:8px}
    canvas.fixed{width:100% !important; height:var(--canvas-h) !important; display:block;}
    .help{color:var(--muted);font-size:12px;margin-top:8px}
    .legend{display:flex; gap:16px; align-items:center; font-size:12px; margin:4px 6px}
    .dot{width:12px;height:4px;border-radius:2px;display:inline-block}
    .price{background:#2563eb}
    .mline{background:#d97706}
  </style>
  <!-- Chart.js + date-fns adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
</head>
<body>
  <h1>Price & M-signals (48h) — fixed size + reliable toggles</h1>
  <div class="meta">Left axis: price. Right axis: score (0–100). Hourly labels; 15‑minute ticks. Dashed black = M2bin (0/100) using threshold (not used in this build).<br>
  Last uploaded (UTC): <span id="last"></span></div>

  <div id="root"></div>

<script>
(async function(){
  const root = document.getElementById('root');
  const lastEl = document.getElementById('last');

  // Make sure the date adapter is available
  if (!Chart._adapters._date || !Chart._adapters._date.adapters?.date) {
    console.warn('Chart.js date adapter missing – time axis will fail.');
  } else {
    console.log('Chart.js date adapter OK.');
  }

  async function load() {
    // IMPORTANT: since this file lives in /docs/, the data is at ./data.json
    const res = await fetch('data.json?t=' + Date.now(), {cache:'no-store'});
    if (!res.ok) throw new Error('Fetch failed: ' + res.status);
    const d = await res.json();
    return d;
  }

  function firstDefined(a){ return a != null ? a : ''; }

  function palette(n){
    const colors = [
      '#2563eb','#16a34a','#d97706','#db2777','#0891b2',
      '#7c3aed','#dc2626','#0ea5e9','#f59e0b','#059669'
    ];
    return colors[n % colors.length];
  }

  function makeCard(sym, series, labels){
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = \`
      <div class="row">
        <strong style="margin-right:10px">\${sym}</strong>
        <label><input type="checkbox" data-k="price" checked> price</label>
        \${Array.from({length:10}).map((_,i)=>\`<label><input type="checkbox" data-k="M\${i+1}"> M\${i+1}</label>\`).join('')}
      </div>
      <div class="legend">
        <span class="dot price"></span> <span>price</span>
        <span class="dot mline" style="background:#666"></span> <span>M-lines (0–100)</span>
      </div>
      <canvas class="fixed"></canvas>
      <div class="help">Toggle lines above. Right axis is fixed at 0–100 for models; left axis is price.</div>
    \`;

    const ctx = card.querySelector('canvas').getContext('2d');
    const ds = [];
    // price
    ds.push({
      label: sym + ' price',
      yAxisID: 'price',
      data: series.price || series.close || [],
      borderColor: '#2563eb',
      backgroundColor: '#2563eb',
      tension: 0.25,
      pointRadius: 0,
    });
    // collect M1..M10 that actually exist & align length
    for (let i=1;i<=10;i++){
      const key = 'M'+i;
      if (Array.isArray(series[key]) && series[key].length === labels.length){
        ds.push({
          label: key,
          yAxisID: 'score',
          data: series[key],
          borderColor: palette(i),
          backgroundColor: palette(i),
          tension: 0.25,
          pointRadius: 0,
          hidden: true
        });
      }
    }

    const chart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: ds },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'nearest', intersect: false },
        scales: {
          x: {
            type: 'time',
            time: { tooltipFormat: 'HH:mm', displayFormats: { minute: 'HH:mm' } },
            ticks: { autoSkip: true, maxRotation: 0 }
          },
          price: {
            position: 'left',
            grid: { drawOnChartArea: true }
          },
          score: {
            position: 'right',
            min: 0, max: 100,
            grid: { drawOnChartArea: false }
          }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });

    // wire toggles
    card.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', () => {
        const k = cb.getAttribute('data-k');
        chart.data.datasets.forEach(ds => {
          if ((k === 'price' && ds.yAxisID === 'price') || ds.label === k){
            ds.hidden = !cb.checked;
          }
        });
        chart.update('none');
      });
    });

    return card;
  }

  try {
    const data = await load();
    lastEl.textContent = firstDefined(data.last_uploaded_utc || data.meta?.last_uploaded_utc || '');

    const labels = data.labels || [];
    const syms = Object.keys(data.symbols || {});

    if (!labels.length || !syms.length){
      root.innerHTML = '<div style="color:#b91c1c">No data found in data.json. Ensure it has {labels, symbols} with arrays.</div>';
      return;
    }

    syms.forEach(sym => {
      const series = data.symbols[sym] || {};
      root.appendChild(makeCard(sym, series, labels));
    });
  } catch (e){
    console.error(e);
    root.innerHTML = '<div style="color:#b91c1c">Failed to load data.json. Open DevTools → Console for details.</div>';
  }
})();
</script>
</body>
</html>
