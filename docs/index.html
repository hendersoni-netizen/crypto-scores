<!doctype html><html><head><meta charset="utf-8"><title>Buy Scores</title>
<style>
body{font-family:-apple-system,Helvetica,Arial,sans-serif;margin:20px}
h2{margin:0 0 8px}
.status{display:flex;gap:16px;align-items:center;margin:8px 0 14px;flex-wrap:wrap}
.dot{width:10px;height:10px;border-radius:50%;background:#ef4444;box-shadow:0 0 6px #ef4444}
.kv span{font-weight:600}
table{border-collapse:collapse;width:100%;margin-top:16px}
th,td{border:1px solid #ddd;padding:6px;text-align:right}
th{text-align:center;background:#f5f5f5}
.container{max-width:1100px;margin:0 auto}
canvas{width:100%;height:420px}
.note{color:#666;font-size:12px;margin-top:6px}
</style></head><body>
<div class="container">
  <h2>Buy Scores (latest per symbol)</h2>
  <div class="status">
    <div id="statusDot" class="dot"></div>
    <div class="kv">Last run (UTC): <span id="lastRun">2025-09-10T09:07:13Z</span></div>
    <div class="kv"><small>Uptime since last run:</small> <span id="uptime">—</span></div>
    <div class="kv"><small>Next run in (~every 15 min):</small> <span id="countdown">—</span></div>
  </div>
  <div style="margin:12px 0">
    <canvas id="scoreChart"></canvas>
    <div class="note">X axis: left = 12 hours ago, right = now.</div>
  </div>
  <div id="tableWrap"><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>symbol</th>
      <th>timestamp_utc</th>
      <th>score</th>
      <th>close</th>
      <th>ema20</th>
      <th>ema50</th>
      <th>rsi</th>
      <th>macd</th>
      <th>macd_signal</th>
      <th>macd_hist</th>
      <th>bb_low</th>
      <th>bb_mid</th>
      <th>bb_high</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>BTC/USDT</td>
      <td>2025-09-10T09:07:09Z</td>
      <td>50</td>
      <td>112200.000000</td>
      <td>112069.460928</td>
      <td>111805.428554</td>
      <td>56.959084</td>
      <td>271.521979</td>
      <td>239.180387</td>
      <td>32.341592</td>
      <td>111122.431183</td>
      <td>111975.621500</td>
      <td>112828.811817</td>
    </tr>
    <tr>
      <td>ETH/USDT</td>
      <td>2025-09-10T09:07:09Z</td>
      <td>50</td>
      <td>4323.870000</td>
      <td>4321.322166</td>
      <td>4316.186163</td>
      <td>53.548104</td>
      <td>5.217440</td>
      <td>4.385380</td>
      <td>0.832061</td>
      <td>4300.205669</td>
      <td>4318.900000</td>
      <td>4337.594331</td>
    </tr>
    <tr>
      <td>ONDO/USDT</td>
      <td>2025-09-10T09:07:09Z</td>
      <td>25</td>
      <td>1.012600</td>
      <td>1.012582</td>
      <td>1.001468</td>
      <td>51.469568</td>
      <td>0.002447</td>
      <td>0.003717</td>
      <td>-0.001270</td>
      <td>1.001178</td>
      <td>1.012540</td>
      <td>1.023902</td>
    </tr>
  </tbody>
</table></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<script>
(function(){
'use strict';

try { console.log('booting scores UI'); } catch(e) {}

var LOOKBACK_HOURS = 12;
var UI_INTERVAL_MINUTES = 15;
var FRESH_MS = 10*60*1000;

var statusDot=document.getElementById('statusDot');
var lastRunEl=document.getElementById('lastRun');
var uptimeEl=document.getElementById('uptime');
var countdownEl=document.getElementById('countdown');

var ctx=document.getElementById('scoreChart').getContext('2d');
var chart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[]},
  options:{responsive:true,interaction:{mode:'nearest',intersect:false},
    plugins:{legend:{position:'top'},title:{display:true,text:'Strong Buy Score (0-100) - last '+LOOKBACK_HOURS+' hours'}},
    scales:{x:{type:'time',time:{tooltipFormat:'HH:mm',displayFormats:{minute:'HH:mm'}},ticks:{autoSkip:true,maxTicksLimit:25}},
            y:{min:0,max:100,ticks:{stepSize:20}}}});

function parseCSV(t){
  var lines=t.replace(/\r/g,'').trim().split('\n'); if(!lines.length) return [];
  var headers=lines.shift().split(',');
  var out=[], i, j, cols, obj;
  for(i=0;i<lines.length;i++){
    cols=lines[i].split(',');
    obj={};
    for(j=0;j<headers.length;j++){ obj[headers[j]]=cols[j]; }
    out.push(obj);
  }
  return out;
}

function fmt(ms){
  if(!(ms>=0)) return '—';
  var s=Math.floor(ms/1000);
  var h=('0'+Math.floor(s/3600)).slice(-2);
  var m=('0'+Math.floor((s%3600)/60)).slice(-2);
  var x=('0'+Math.floor(s%60)).slice(-2);
  return h+':'+m+':'+x;
}

function floor15(d){ var step=900000; return new Date(Math.floor(d.getTime()/step)*step); }
function nextCountdown(){ var step=900000; var n=new Date(Math.ceil(Date.now()/step)*step); return n-Date.now(); }

function buildTimeline(lastMs,hours){
  var end=new Date(lastMs), start=new Date(end.getTime()-hours*3600000);
  var out=[], step=900000, t;
  for(t=floor15(start); t<=floor15(end); t=new Date(t.getTime()+step)){ out.push(new Date(t).toISOString()); }
  return out;
}

function seriesFromRows(rows,timeline){
  var bySym={}, seen={}, i, s;
  for(i=0;i<rows.length;i++){ seen[rows[i].symbol]=true; }
  for(s in seen){ if(seen.hasOwnProperty(s)){ bySym[s]=[]; for(i=0;i<timeline.length;i++) bySym[s].push(null); } }

  var idx={}; for(i=0;i<timeline.length;i++){ idx[timeline[i]]=i; }

  rows.sort(function(a,b){ return Date.parse(a.timestamp_utc)-Date.parse(b.timestamp_utc); });

  rows.forEach(function(r){
    var t=Date.parse(r.timestamp_utc);
    if(!(t>0)) return;
    var bucket=floor15(new Date(t)).toISOString();
    var k=idx[bucket]; if(k===undefined) return;
    var v=parseInt(r.score,10);
    if(v>=0) bySym[r.symbol][k]=v;
  });
  return bySym;
}

function renderTable(latest){
  var cols=["timestamp_utc","symbol","score","close","ema20","ema50","rsi","macd","macd_signal","macd_hist","bb_low","bb_mid","bb_high"];
  var html='<table><thead><tr>';
  for(var i=0;i<cols.length;i++){ html+='<th>'+cols[i]+'</th>'; }
  html+='</tr></thead><tbody>';
  latest.forEach(function(r){
    html+='<tr>';
    for(var i=0;i<cols.length;i++){ var c=cols[i]; html+='<td>'+(r[c]||'')+'</td>'; }
    html+='</tr>';
  });
  html+='</tbody></table>';
  document.getElementById('tableWrap').innerHTML=html;
}

function loadAndUpdate(){
  fetch('buy_scores.csv?t='+(Date.now()),{cache:'no-store'})
  .then(function(res){ if(!res.ok) throw new Error('HTTP '+res.status); return res.text(); })
  .then(function(text){
    var rows=parseCSV(text);
    if(!rows.length) return;

    var times=rows.map(function(r){ return Date.parse(r.timestamp_utc); }).filter(function(n){ return n>0; });
    if(!times.length) throw new Error('no parseable timestamps');
    var lastMs=Math.max.apply(null,times);
    lastRunEl.textContent=new Date(lastMs).toISOString();

    var ms=Date.now()-lastMs;
    var fresh=ms<FRESH_MS;
    statusDot.style.background=fresh?'#22c55e':'#ef4444';
    statusDot.style.boxShadow=fresh?'0 0 6px #22c55e':'0 0 6px #ef4444';
    uptimeEl.textContent=fmt(ms);
    countdownEl.textContent=fmt(nextCountdown());

    var latestMap={}, ordered=[];
    rows.slice().sort(function(a,b){ return Date.parse(b.timestamp_utc)-Date.parse(a.timestamp_utc); })
      .forEach(function(r){ if(!latestMap[r.symbol]){ latestMap[r.symbol]=r; ordered.push(r); }});
    renderTable(ordered);

    var tl=buildTimeline(lastMs, LOOKBACK_HOURS);
    var series=seriesFromRows(rows, tl);
    chart.data.labels=tl;

    var palette=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];
    var ds=[], idx=0, sym;
    for(sym in series){
      if(!series.hasOwnProperty(sym)) continue;
      ds.push({
        label:sym,
        data:series[sym],
        borderColor:palette[idx%palette.length],
        backgroundColor:palette[idx%palette.length],
        spanGaps:true,
        tension:0.25,
        pointRadius:3,
        pointHoverRadius:5
      });
      idx++;
    }
    chart.data.datasets=ds;
    chart.update('none');
  })
  .catch(function(e){ try{ console.error('load error', e); }catch(_e){} });
}

loadAndUpdate();
setInterval(function(){
  var s=Date.parse((lastRunEl.textContent||'').trim());
  if(s>0){
    var ms=Date.now()-s;
    uptimeEl.textContent=fmt(ms);
    countdownEl.textContent=fmt(nextCountdown());
  }
},1000);
setInterval(loadAndUpdate,30000);

})();</script></body></html>