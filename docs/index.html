<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Price & Strong Buy score (last 48 hours)</title>
  <style>
    body{font-family:-apple-system,Helvetica,Arial,sans-serif;margin:20px;}
    .container{max-width:1100px;margin:0 auto;}
    .chart-card{margin:18px 0;padding:12px 12px 6px;border:1px solid #eee;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);}
    .header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin:6px 0 2px}
    .meta{color:#666;font-size:12px}
    .toggles label{margin-right:10px;font-size:12px;user-select:none}
    canvas{width:100%;height:340px}
  </style>
</head>
<body>
<div class="container">
  <h3>Price & Strong Buy score (last 48 hours)</h3>
  <div class="meta">Left axis: price. Right axis: score (0–100). Hourly labels; 15‑minute ticks.
    <br><span id="lastUpdated"></span>
  </div>
  <div id="charts"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<script>
(async () => {
  const res = await fetch('data.json?t=' + Date.now(), {cache:'no-store'});
  const data = await res.json();
  document.getElementById('lastUpdated').textContent =
    'Last updated (UTC): ' + new Date(data.meta.updated_utc).toISOString();

  const labels = data.labels.map(t => new Date(t));
  const palette = ['#1f77b4','#d62728','#2ca02c','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf','#ff7f0e'];

  function makeCard(sym) {
    const wrap = document.createElement('div');
    wrap.className = 'chart-card';
    const head = document.createElement('div');
    head.className = 'header';
    head.innerHTML = `<b>${sym}</b> <span class="toggles"></span>`;
    const toggles = head.querySelector('.toggles');
    const c = document.createElement('canvas'); wrap.append(head,c);
    document.getElementById('charts').appendChild(wrap);
    const ctx = c.getContext('2d');

    const price = data.symbols[sym].close;
    const models = data.models[sym];

    // default: show M10 only
    const enabled = {M10:true};
    Object.keys(models).forEach(k => { if(!(k in enabled)) enabled[k]=false });

    // build checkboxes
    Object.keys(models).sort().forEach((k,i) => {
      const id = sym.replace(/[^A-Za-z0-9]/g,'') + '_' + k;
      const cb = document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.checked=enabled[k];
      const lab = document.createElement('label'); lab.htmlFor=id; lab.style.color = palette[i%palette.length];
      lab.textContent = ' ' + k + ' ';
      toggles.append(cb, lab);
    });

    // Now line plugin
    const lastLabel = labels[labels.length-1];
    const nowLine = {
      id:'nowline',
      afterDatasetsDraw(chart, args, opts){
        const {ctx, chartArea:{left, right, top, bottom}, scales:{x}} = chart;
        ctx.save(); ctx.strokeStyle='#111'; ctx.setLineDash([2,2]); ctx.lineWidth=1.2;
        const xNow = x.getPixelForValue(lastLabel);
        ctx.beginPath(); ctx.moveTo(xNow, top); ctx.lineTo(xNow, bottom); ctx.stroke(); ctx.restore();
      }
    };

    const chart = new Chart(ctx, {
      type: 'line',
      data: {labels, datasets:[
        {label: sym+' price', yAxisID:'price', data: price, borderColor:'#5585c2', tension:.25, spanGaps:true, pointRadius:0},
      ]},
      options: {
        responsive:true, interaction:{mode:'nearest', intersect:false},
        scales: {
          x: { type:'time', time:{tooltipFormat:'HH:mm', displayFormats:{minute:'HH:mm'}}, ticks:{autoSkip:true, maxTicksLimit:49}},
          price: { position:'left', grid:{color:'rgba(0,0,0,.06)'}},
          score: { position:'right', min:0, max:100, ticks:{stepSize:10}, grid:{drawOnChartArea:false} }
        },
        plugins:{ legend:{position:'top'} }
      },
      plugins:[nowLine]
    });

    function rebuild(){
      const ds = [ chart.data.datasets[0] ];
      let i=0;
      Object.keys(models).sort().forEach(k=>{
        const cb = toggles.querySelector(`#${sym.replace(/[^A-Za-z0-9]/g,'')}_${k}`);
        if(cb && cb.checked){
          ds.push({label:k, yAxisID:'score', data: models[k], tension:.25, spanGaps:true, pointRadius:0,
                   borderColor: palette[i%palette.length] });
        }
        i++;
      });
      chart.data.datasets = ds;
      chart.update('none');
    }

    toggles.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.addEventListener('change', rebuild));
    rebuild();
  }

  Object.keys(data.symbols).forEach(makeCard);
})().catch(e=>console.error(e));
</script>
</body>
</html>
