<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Price & M-signals (48h) — fixed size + axis mapping</title>
  <style>
    :root { --fg:#0f172a; --mut:#64748b; --line:#0ea5e9; --bg:#fff; --card:#f8fafc; }
    html,body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans",
                "Liberation Sans", sans-serif; background:var(--bg); color:var(--fg); }
    .page { max-width: 1100px; margin: 28px auto; padding: 0 16px 64px; }
    h1 { font-size: 22px; margin: 0 0 6px; }
    .sub { color: var(--mut); font-size: 13px; margin-bottom: 16px; }
    .chartcard { background: var(--card); border: 1px solid #e2e8f0; border-radius: 12px; padding: 14px 14px 8px; margin: 18px 0; }
    .row { display: flex; gap:10px; align-items:center; flex-wrap: wrap; margin: 6px 0 10px; }
    .row label { font-size: 13px; color: var(--fg); display:inline-flex; align-items:center; gap:6px; padding:2px 6px; border-radius:8px; background:#fff; border:1px solid #e2e8f0; }
    .row input[type="checkbox"] { transform: translateY(1px); }
    .row input[type="number"] { width:68px; padding:4px 6px; border-radius:8px; border:1px solid #e2e8f0; }
    .legend { font-size: 12px; color: var(--mut); margin-top: 6px; }
    canvas { width: 100%; height: 360px; }
    .pill { font-size:12px; padding:2px 8px; border-radius:999px; border:1px dashed #111; }
    .sep { flex:1; height:1px; }
    .help { color: var(--mut); font-size:12px; }
  </style>
</head>
<body>
  <div class="page">
    <h1>Price & M-signals (48h) — fixed size + axis mapping</h1>
    <div class="sub">
      Left axis: price. Right axis: score (0–100). Hourly labels; 15-minute ticks.
      <span class="pill">M2bin</span> = M2 binary (0/100) using threshold.
      <div id="uploaded" class="help" style="margin-top:6px;">Last uploaded (UTC): —</div>
    </div>

    <div id="charts"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script>
  (async function(){
    const res = await fetch('data.json?t=' + Date.now(), {cache:'no-store'});
    if(!res.ok) throw new Error('Failed to load data.json');
    const full = await res.json();
    const labels = (full.labels || []).map(t => new Date(t));
    if (full.meta && full.meta.last_uploaded_utc) {
      document.getElementById('uploaded').textContent = 'Last uploaded (UTC): ' + full.meta.last_uploaded_utc;
    }
    const symbols = full.symbols || full.Symbols || {};

    const order = Object.keys(symbols); // whatever exists (BTC/USDT, ETH/USDT, ...)
    const colors = {
      price: '#0ea5e9',
      m1:'#111827', m2:'#dc2626', m3:'#0d9488', m4:'#6366f1', m5:'#16a34a',
      m6:'#f59e0b', m7:'#7c3aed', m8:'#14b8a6', m9:'#ef4444', m10:'#10b981',
      m2bin:'#111'
    };

    const chartArea = document.getElementById('charts');

    order.forEach((sym, idx) => {
      const s = symbols[sym] || {};
      // helpers: accept both lower & upper keys (m1/M1)
      function pick(k){
        const lo = k.toLowerCase(), up = k.toUpperCase();
        if (s[lo]) return s[lo];
        if (s[up]) return s[up];
        return null;
      }
      const close = pick('close') || [];
      const series = {
        m1: pick('m1'), m2: pick('m2'), m3: pick('m3'), m4: pick('m4'), m5: pick('m5'),
        m6: pick('m6'), m7: pick('m7'), m8: pick('m8'), m9: pick('m9'), m10: pick('m10')
      };

      // Card DOM
      const card = document.createElement('div');
      card.className = 'chartcard';
      card.innerHTML = `
        <div class="row">
          <strong>${sym}</strong>
          <label><input type="checkbox" data-k="price" checked> price</label>
          <label><input type="checkbox" data-k="m1"> M1</label>
          <label><input type="checkbox" data-k="m2"> M2</label>
          <label><input type="checkbox" data-k="m3"> M3</label>
          <label><input type="checkbox" data-k="m4"> M4</label>
          <label><input type="checkbox" data-k="m5"> M5</label>
          <label><input type="checkbox" data-k="m6"> M6</label>
          <label><input type="checkbox" data-k="m7"> M7</label>
          <label><input type="checkbox" data-k="m8"> M8</label>
          <label><input type="checkbox" data-k="m9"> M9</label>
          <label><input type="checkbox" data-k="m10"> M10</label>
          <label><input type="checkbox" data-k="m2bin"> M2bin</label>
          <span class="sep"></span>
          <span class="help">M2 threshold:</span>
          <input type="number" min="0" max="100" step="1" value="50" class="thr">
        </div>
        <canvas></canvas>
        <div class="legend">Dashed black = M2bin</div>
      `;
      chartArea.appendChild(card);

      const ctx = card.querySelector('canvas').getContext('2d');
      const thrInput = card.querySelector('.thr');

      // base datasets
      const datasets = [];
      function pushDataset(key){
        if (key === 'price') {
          datasets.push({
            key, label: sym + ' price', data: zip(labels, close),
            parsing: false, borderColor: colors.price, backgroundColor: colors.price,
            yAxisID:'price', tension: 0.25, spanGaps: true, pointRadius: 0
          });
          return;
        }
        if (key === 'm2bin') {
          const t = Number(thrInput.value || 50);
          const m2 = series.m2 || [];
          const bin = m2.map(v => (Number(v) > t ? 100 : 0));
          datasets.push({
            key, label: 'M2bin', data: zip(labels, bin),
            parsing:false, borderColor: colors.m2bin, backgroundColor: colors.m2bin,
            yAxisID:'score', tension:0, spanGaps:true, pointRadius:0, borderDash:[8,6]
          });
          return;
        }
        // model lines M1..M10
        const arr = series[key] || [];
        if (!arr || !arr.length) return;
        datasets.push({
          key, label: key.toUpperCase(), data: zip(labels, arr),
          parsing:false, borderColor: colors[key], backgroundColor: colors[key],
          yAxisID:'score', tension:0.25, spanGaps:true, pointRadius:0
        });
      }

      // seed with price only
      pushDataset('price');

      const chart = new Chart(ctx, {
        type:'line',
        data:{ datasets },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          scales:{
            x:{ type:'time', time:{ tooltipFormat:'HH:mm', displayFormats:{ minute:'HH:mm' } } },
            price:{ position:'left', grid:{ color:'rgba(0,0,0,.06)' } },
            score:{ position:'right', min:0, max:100, grid:{ color:'rgba(0,0,0,.06)' } }
          },
          interaction:{ mode:'nearest', intersect:false }
        }
      });

      // checkbox toggling
      card.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', () => {
          const key = cb.dataset.k;
          const idx = chart.data.datasets.findIndex(d => d.key === key);
          if (cb.checked) {
            if (idx === -1) { // add
              pushDataset(key);
            } else {
              chart.data.datasets[idx].hidden = false;
            }
          } else {
            if (idx !== -1) chart.data.datasets[idx].hidden = true;
          }
          chart.update('none');
        });
      });

      // threshold recompute for M2bin
      thrInput.addEventListener('input', () => {
        const idx = chart.data.datasets.findIndex(d => d.key === 'm2bin');
        if (idx !== -1) {
          // rebuild series
          const t = Number(thrInput.value || 50);
          const m2 = series.m2 || [];
          const bin = m2.map(v => (Number(v) > t ? 100 : 0));
          chart.data.datasets[idx].data = zip(labels, bin);
          chart.update('none');
        }
      });
    });

    function zip(xs, ys){
      const n = Math.min(xs.length, ys.length);
      const out = new Array(n);
      for (let i=0;i<n;i++) out[i] = {x: xs[i], y: Number(ys[i])};
      return out;
    }
  })().catch(e => {
    console.error(e);
    alert('Failed to build models_48h page: ' + e.message);
  });
  </script>
</body>
</html>
