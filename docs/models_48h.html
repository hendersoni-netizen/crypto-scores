<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Price & M-signals (48h) — fixed size + axis mapping</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root { --fg:#0f172a; --mut:#64748b; --line:#e2e8f0; --card:#ffffff; --accent:#2563eb; }
  body { font: 14px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--fg); margin:24px; background:#f8fafc; }
  h1 { font-size:20px; margin:0 0 6px; }
  .mut { color:var(--mut); }
  .wrap { max-width: 1150px; margin: 0 auto; }
  .card { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px 16px 12px; margin:18px 0; box-shadow:0 1px 0 rgba(0,0,0,.02); }
  .head { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:2px 0 10px; }
  .head b { font-weight:700; margin-right:10px; }
  .tog { display:inline-flex; align-items:center; gap:6px; margin-right:6px; }
  .tog input[type="checkbox"]{ width:15px; height:15px; }
  .tog input[type="number"]{ width:64px; padding:4px 6px; border:1px solid var(--line); border-radius:8px; font-size:13px; }
  canvas { width:100% !important; height:360px !important; display:block; }
  .note { color:var(--mut); font-size:12px; margin-top:8px; }
  .legend { display:inline-block; padding:2px 8px; border-radius:8px; font-size:12px; border:1px solid var(--line); background:#fff; }
  .dash { border-bottom:2px dashed #111; display:inline-block; width:26px; transform:translateY(2px); margin-right:4px; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Price & M-signals (48h) — fixed size + axis mapping</h1>
  <div class="mut">Left axis: price. Right axis: score (0–100). Hourly labels; 15-minute ticks. <span class="legend"><span class="dash"></span>M2bin</span> = M2 binary (0/100) using threshold.</div>
  <div id="ts" class="mut" style="margin-top:6px;"></div>

  <div id="app"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<script>
(async function(){
  // Load data with cache-bust
  const res = await fetch('data.json?t='+Date.now(), {cache:'no-store'});
  if(!res.ok){ document.getElementById('app').innerHTML = '<div class="mut">docs/data.json not found.</div>'; return; }
  const data = await res.json();
  const labels = (data.labels || []).map(d => new Date(d));
  document.getElementById('ts').textContent = 'Last uploaded (UTC): ' + (data.meta?.last_uploaded_utc || '—');

  // Symbols present in file (fallback to known)
  const SYMS = Object.keys(data.symbols || {"BTC/USDT":{}, "ETH/USDT":{}, "ONDO/USDT":{}});

  // Nice colors
  const colors = ['#2563eb','#16a34a','#fb923c','#a855f7','#06b6d4','#ef4444','#f59e0b','#10b981','#8b5cf6','#dc2626'];
  const mColor = i => colors[i % colors.length];

  // Build each symbol card
  const app = document.getElementById('app');

  for(const sym of SYMS){
    const s = data.symbols?.[sym] || {};
    // Build series map
    const series = { close: s.close || [] };
    for(let i=1;i<=10;i++){
      const key='M'+i;
      if(Array.isArray(s[key])) series[key]=s[key];
    }

    // Card shell
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="head">
        <b>${sym}</b>
        <label class="tog"><input type="checkbox" data-type="price" checked> price</label>
        ${Array.from({length:10},(_,i)=>`<label class="tog"><input type="checkbox" data-type="M${i+1}"> M${i+1}</label>`).join('')}
        <label class="tog"><input type="checkbox" data-type="M2bin"> M2bin</label>
        <span class="tog">M2 threshold: <input type="number" min="0" max="100" step="1" value="50" data-role="th"></span>
      </div>
      <canvas></canvas>
      <div class="note">Dashed black = M2bin</div>
    `;
    app.appendChild(card);

    const ctx = card.querySelector('canvas').getContext('2d');
    const thEl = card.querySelector('input[data-role="th"]');

    // Build datasets
    const ds = [];
    // Price (left scale)
    if(Array.isArray(series.close) && series.close.length){
      ds.push({
        label: sym+' price',
        data: series.close,
        borderColor: '#2563eb',
        backgroundColor: '#2563eb',
        yAxisID: 'price',
        tension:.25, pointRadius:0, spanGaps:true,
        hidden:false,
      });
    }

    // M1..M10 (right scale, hidden by default)
    let mIndex=0;
    for(let i=1;i<=10;i++){
      const key='M'+i;
      if(!series[key]) continue;
      ds.push({
        label: key,
        data: series[key],
        borderColor: mColor(mIndex++),
        backgroundColor: 'transparent',
        yAxisID: 'score',
        tension:.25, pointRadius:0, spanGaps:true,
        hidden:true,
      });
    }

    // M2bin dataset (computed below)
    const m2binIndex = ds.length;
    ds.push({
      label:'M2bin',
      data: [],
      borderColor:'#111', backgroundColor:'transparent',
      yAxisID:'score',
      borderDash:[6,4],
      tension:0, pointRadius:0, spanGaps:true,
      hidden:true,
    });

    // Compute M2 binary from threshold
    function recomputeM2bin(){
      const thr = Math.max(0, Math.min(100, Number(thEl.value)||0));
      const m2 = series['M2'] || [];
      const out = m2.map(v => (Number(v) > thr ? 100 : 0));
      ds[m2binIndex].data = out;
      chart.update('none');
    }

    const chart = new Chart(ctx, {
      type:'line',
      data:{ labels, datasets: ds },
      options:{
        responsive:true, maintainAspectRatio:false,
        interaction:{ mode:'nearest', intersect:false },
        scales:{
          x:{ type:'time', time:{ unit:'hour', tooltipFormat:'MMM d HH:mm' }, grid:{ color:'rgba(0,0,0,.06)' }},
          price:{ position:'left', grid:{ color:'rgba(0,0,0,.06)' }, ticks:{ maxTicksLimit:8 } },
          score:{ position:'right', min:0, max:100, grid:{ drawOnChartArea:false }, ticks:{ stepSize:10 } }
        },
        plugins:{ legend:{ display:false } }
      }
    });

    // Enable only checkboxes that have data
    for(const cb of card.querySelectorAll('input[type="checkbox"][data-type]')){
      const key = cb.getAttribute('data-type');
      if(key==='price'){ cb.disabled = !series.close?.length; cb.checked = true; continue; }
      if(key==='M2bin'){ cb.disabled = !(series.M2?.length); continue; }
      cb.disabled = !(series[key]?.length);
    }

    // Wire toggles
    card.querySelectorAll('input[type="checkbox"][data-type]').forEach(cb=>{
      const key = cb.getAttribute('data-type');
      cb.addEventListener('change', ()=>{
        let idx = -1;
        if(key==='price'){
          idx = ds.findIndex(d => d.yAxisID==='price');
        }else if(key==='M2bin'){
          idx = m2binIndex;
        }else{
          idx = ds.findIndex(d => d.label===key);
        }
        if(idx>=0){ ds[idx].hidden = !cb.checked; chart.update('none'); }
      });
    });

    thEl.addEventListener('input', ()=>{ recomputeM2bin(); });

    // First compute
    recomputeM2bin();
  }
})();
</script>
</body>
</html>
